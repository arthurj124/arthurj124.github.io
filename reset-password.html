<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Redefinir Senha - Vitacare</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- CSS exclusivo do reset -->
    <link rel="stylesheet" href="css/reset.css" />
  </head>

  <body>
    <div class="card">
      <h2>Redefinir senha</h2>
      <p>Digite sua nova senha abaixo.</p>

      <input type="password" id="newPassword" placeholder="Nova senha" />
      <input
        type="password"
        id="confirmPassword"
        placeholder="Confirmar nova senha"
      />

      <button class="login-btn" onclick="resetPassword()">
        Salvar nova senha
      </button>
      <button class="back-btn" onclick="window.location.href='index.html'">
        Voltar ao Login
      </button>

      <p id="resetSuccessMsg" style="color: green; display: none"></p>
      <p id="resetErrorMsg" style="color: red; display: none"></p>
    </div>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Arquivo principal (contém o supabase.createClient) -->
    <script src="js/main.js"></script>

    <script>
      // Quando abrir a página, checa se o Supabase já autenticou a recuperação
      document.addEventListener("DOMContentLoaded", async () => {
        console.log(
          "reset-password.html carregado, hash:",
          window.location.hash
        );

        const { data, error } = await supabase.auth.getUser();

        if (error || !data.user) {
          const msg = document.getElementById("resetErrorMsg");
          msg.textContent = "Link inválido ou expirado. Solicite novamente.";
          msg.style.display = "block";
        }
      });

      async function resetPassword() {
        const newPassword = document.getElementById("newPassword").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;

        const successMsg = document.getElementById("resetSuccessMsg");
        const errorMsg = document.getElementById("resetErrorMsg");

        successMsg.style.display = "none";
        errorMsg.style.display = "none";

        if (!newPassword || !confirmPassword) {
          errorMsg.textContent = "Preencha as duas senhas.";
          errorMsg.style.display = "block";
          return;
        }

        if (newPassword !== confirmPassword) {
          errorMsg.textContent = "As senhas não conferem.";
          errorMsg.style.display = "block";
          return;
        }

        const { error } = await supabase.auth.updateUser({
          password: newPassword,
        });

        if (error) {
          console.error("Erro ao atualizar senha:", error);
          errorMsg.textContent =
            "Erro ao redefinir senha. O link pode ter expirado.";
          errorMsg.style.display = "block";
          return;
        }

        successMsg.textContent =
          "Senha alterada com sucesso! Redirecionando...";
        successMsg.style.display = "block";

        setTimeout(() => {
          window.location.href = "index.html";
        }, 1500);
      }
    </script>
  </body>
</html>
